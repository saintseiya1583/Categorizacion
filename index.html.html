<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Categorización de Entes Operadores ASADA</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
    body { font-family: Calibri, Arial, sans-serif; background: #f7f7fa; color: #222; margin: 0; }
    main { max-width: 850px; margin: 30px auto 70px auto; background: #fff; border-radius: 16px; box-shadow: 0 1px 24px #0002; padding: 32px 18px 30px 18px; }
    h1, h2, h3 { color: #2776b7; font-weight: bold; }
    .campo { margin-bottom: 16px; }
    .responsable { margin-bottom: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f6f6ff; }
    .boton { padding: 9px 22px; font-size: 1rem; border-radius: 7px; border: none; background: #2776b7; color: #fff; margin-right: 10px; cursor: pointer; margin-top: 10px;}
    .boton[disabled], .boton.disabled { background: #aaa; cursor: not-allowed; }
    .obligatorio { color: red; }
    .pregunta { margin-bottom: 18px; background: #fcfdff; border-radius: 8px; padding: 13px 14px; box-shadow: 0 1px 6px #0001; }
    .porcentaje { font-size: 0.98em; color: #222; background: #e9e9f4; padding: 3px 10px; border-radius: 8px; margin-right: 10px; display: inline-block;}
    .puntaje { font-size: 1.1em; font-weight: bold; color: #2776b7; }
    .totalizador { margin-top: 25px; padding: 10px 12px; background: #edf6ed; border-radius: 10px; font-size: 1.13em; border: 1px solid #cce2cc; }
    .radio-grupo { margin-bottom: 6px; display: flex; align-items: center;}
    .radio-grupo input[type="radio"] { margin-right: 8px; }
    .nav { margin-top: 28px; }
    .oculto { display: none !important; }
    .roja { color: #b80000 !important; }
    .verde { 
        color: #0b8527 !important;
        font-weight: bold;
    }
    .azul { color: #2776b7 !important; }
    .naranja { 
        color: #e88318 !important;
        font-weight: bold;
    }
    .amarillo { 
        color: #e8c818 !important;
        font-weight: bold;
    }
    .tabla-resumen {
        width: 100%; border-collapse: collapse; margin-top: 30px; margin-bottom: 26px;
    }
    .tabla-resumen th, .tabla-resumen td {
        border: 1.7px solid #aac8e8; padding: 8px 10px; font-size: 1.08em; text-align: left;
    }
    .tabla-resumen th {
        background: #2776b7; color: #fff; font-weight: bold; text-align: center; font-size: 1.09em; letter-spacing: 0.05em;
    }
    .tabla-resumen .total-fila, .tabla-resumen tfoot td {
        background: #2776b7; color: #fff; font-weight: bold; font-size: 1.1em;
    }
    .tabla-resumen .verde { color: #0b8527; }
    .tabla-resumen .roja { color: #b80000; }
    .tabla-resumen .azul { color: #2776b7; }
    .tabla-resumen .naranja { color: #e88318 !important; }
    .tabla-resumen .amarillo { color: #e8c818 !important; }
    .tabla-resumen .categoria-celda {
        text-align: center; font-size: 2.6em; font-family: Calibri, Arial, sans-serif; font-weight: bold; vertical-align: middle;
    }
    .tabla-resumen .categoria-celda.verde { color: #0b8527; }
    .tabla-resumen .categoria-celda.naranja { color: #e88318; }
    .tabla-resumen .categoria-celda.amarillo { color: #e8c818; }
    .tabla-resumen .categoria-celda.roja { color: #b80000; }
    .info-mensaje { background: #fff4e5; border-left: 5px solid #b80000; padding: 15px 14px; border-radius: 8px; margin-bottom: 23px; color: #b80000; font-size: 1.13em; }
    .tabla-detalle { width: 100%; border-collapse: collapse; margin-top: 30px; margin-bottom: 26px;}
    .tabla-detalle th, .tabla-detalle td {
        border: 1.5px solid #ccd9e8; padding: 7px 9px; font-size: 1.03em;
    }
    .tabla-detalle th { background: #2776b7; color: #fff; font-weight: bold; }
    .flex { display: flex; align-items: center; }
    .info-general-resumen { margin: 8px 0 25px 0; padding: 13px 14px 13px 24px; border: 1.6px solid #2776b7; border-radius: 10px; background: #f6faff;}
    .info-general-resumen b { color: #2776b7; }
    /* Cuadro informativo por código */
    .cuadro-informativo-categorias {
    max-width: 700px !important;
    border: 1.2px solid #2776b7 !important;
    box-shadow: 0 1px 5px #2776b733 !important;
    margin: 15px auto 15px auto !important;
}

    .cuadro-informativo-categorias table {
        border-collapse: collapse; width: 100%; font-size: 1.05em;
    }
    .cuadro-informativo-categorias th, .cuadro-informativo-categorias td {
        border: 1.2px solid #2776b7; padding: 7px 8px; text-align: left;
    }
    .cuadro-informativo-categorias th {
        background: #2776b7; color: #fff; font-size: 1.06em; text-align: center;
    }
    .cuadro-informativo-categorias .verde { color: #0b8527; }
    .cuadro-informativo-categorias .naranja { color: #e88318; }
    .cuadro-informativo-categorias .amarillo { color: #e8c818; }
    .cuadro-informativo-categorias .roja { color: #b80000; }
    @media (max-width: 750px) {
        main { padding: 8px 2vw 15vw 2vw; }
        .tabla-resumen, .tabla-detalle { font-size: 0.98em; }
        .tabla-resumen .categoria-celda { font-size: 1.8em; }
    }
</style>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<main>
    <!-- Páginas dinámicas -->
    <section id="pagina-general">
        <h1>Categorización de Entes Operadores Costa Rica</h1>
        <h2>Información General de la ASADA</h2>
        <div class="campo">
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" name="fecha">
        </div>
        <div class="campo">
            <label for="asada">Nombre de la ASADA <span class="obligatorio">*</span>:</label>
            <input type="text" id="asada" name="asada" required>
        </div>
        <div class="campo">
            <label for="region">Región:</label>
            <select id="region" name="region">
                <option value="">Seleccione...</option>
                <option>Brunca</option>
                <option>Central este</option>
                <option>Chorotega</option>
                <option>Huetar Caribe</option>
                <option>Huetar Norte</option>
                <option>Metropolitana</option>
                <option>Pacífico Central</option>
            </select>
        </div>
        <div class="campo">
            <label for="provincia">Provincia:</label>
            <select id="provincia" name="provincia">
                <option value="">Seleccione...</option>
                <option>Alajuela</option>
                <option>Cartago</option>
                <option>Guanacaste</option>
                <option>Heredia</option>
                <option>Limón</option>
                <option>Puntarenas</option>
                <option>San José</option>
            </select>
        </div>
        <div class="campo">
            <label for="canton">Cantón:</label>
            <input type="text" id="canton" name="canton">
        </div>
        <div class="campo">
            <label for="distrito">Distrito:</label>
            <input type="text" id="distrito" name="distrito">
        </div>
        <div class="campo">
            <label for="telefono">Teléfono:</label>
            <input type="tel" id="telefono" name="telefono">
        </div>
        <div class="campo">
            <label for="conexiones">Número de conexiones:</label>
            <input type="number" id="conexiones" name="conexiones" min="1">
        </div>
        <div class="campo">
            <label for="comunidades">Número de comunidades:</label>
            <input type="number" id="comunidades" name="comunidades" min="1">
        </div>
        <div id="responsables">
            <div class="responsable">
                <label>Puesto <span class="obligatorio">*</span>:</label>
                <input type="text" name="puesto[]" required><br>
                <label>Nombre <span class="obligatorio">*</span>:</label>
                <input type="text" name="nombre[]" required>
            </div>
        </div>
        <button type="button" class="boton" onclick="agregarResponsable()">Agregar otro responsable</button>
        <div class="nav">
            <button type="button" class="boton" onclick="avanzarPagina(1)">Siguiente</button>
        </div>
    </section>

    <!-- SECCIONES DINÁMICAS DE EJES (se generan por JS) -->

    <!-- Página resumen final -->
    <section id="pagina-resumen" class="oculto">
        <h2>Resumen Final de Resultados</h2>
        <div id="info-general-resumen"></div>
        <div id="resumen-ejes"></div>
        <div class="flex" id="categoria-resultado"></div>
        <div id="cuadro-informativo-categorias"></div>
        <div id="detalle-preguntas"></div>
        <div class="nav">
            <button type="button" class="boton" onclick="volverARespuestas()">Volver</button>
            <button type="button" class="boton" id="btnPDF" onclick="exportarPDF()">exportar resultado a PDF</button>
        </div>
    </section>
</main>

<script>
// ==== Estructura de todos los ejes ====
// (igual que antes, solo el eje de saneamiento no se valida como obligatorio)
const EJES = [
    {
        nombre: "Gestión Comercial",
        color: "azul", tipo: "principal",
        preguntas: [
            { texto: "¿Se realiza lectura mensual de los hidrómetros?", puntos: 1, porcentaje: 1, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Qué tipo de sistema de facturación se utiliza?", puntos: 2, porcentaje: 1, opciones: ["No hay", "Manual", "Sistema Electrónico"], color:"azul" },
            { texto: "¿Se lleva el registro de agua no contabilizada?", puntos: 1, porcentaje: 1, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Cuentan con balance hídrico positivo actualizado para atender la demanda de crecimiento vegetativo a 20 años?", puntos: 1, porcentaje: 3, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Cuál es el porcentaje de micromedición instalado en funcionamiento?", puntos: 3, porcentaje: 4, opciones: ["No hay", "<= 50%", "> 50% y < 75%", "> 75% y <= 100%"], color:"azul" },
            { texto: "¿Qué tipo de local se utiliza para la atención de los clientes?", puntos: 3, porcentaje: 2, opciones: ["No", "Vivienda Particular", "Instalación Comunal", "Oficina"], color:"azul" },
            { texto: "¿Aplican las tarifas vigentes establecidas por ARESEP?", puntos: 1, porcentaje: 4, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Cuáles son los medios de pago externos utilizados por el ente operador?", puntos: 2, porcentaje: 1, opciones: ["No hay", "Agente recaudador informal", "Sistema informático por conectividad"], color:"azul" }
        ]
    },
    {
        nombre: "Gestión Comunal",
        color: "azul", tipo: "principal",
        preguntas: [
            { texto: "¿Se cuenta con mecanismos para la transparencia y rendición de cuentas?", puntos: 3, porcentaje: 2, opciones: ["No hay", "En asambleas", "Boletines comunales y/o redes sociales", "Plan de transparencia y rendición de cuentas"], color:"azul" },
            { texto: "¿Organizan acciones para involucrar a la población en actividades de participación comunal?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se promueven acciones para la afiliación de sus usuarios?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se promueven actividades para la participación comunal que incluya la equidad de género?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" }
        ]
    },
    {
        nombre: "Gestión Ambiental y de Recurso Hídrico",
        color: "azul", tipo: "principal",
        preguntas: [
            { texto: "¿Se cuenta con estudio hidrogeológico que define las áreas de protección aprobado por la UEN de Gestión Ambiental?", puntos: 2, porcentaje: 3, opciones: ["Ninguno", "En proceso de aprobación", "Aprobado"], color:"azul" },
            { texto: "¿Organizan acciones de conciencia y protección al recurso hídrico?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Cuenta con todas las fuentes inscritas ante el MINAE?", puntos: 1, porcentaje: 3, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se realizan aforos mensuales?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" }
        ]
    },
    {
        nombre: "Gestión de Sistemas de Agua",
        color: "azul", tipo: "principal",
        preguntas: [
            { texto: "¿El ente operador ha realizado la gestión con el cuerpo de bomberos para la instalación de hidrantes?", puntos: 1, porcentaje: 1, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Los hidrantes están operando correctamente?", puntos: 1, porcentaje: 1, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se realiza la bitácora de continuidad para el control de interrupciones del servicio?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se tienen reportes de quejas o denuncias comprobadas de la no continuidad del servicio del ente operador?", puntos: 1, porcentaje: 1, opciones: ["Sí", "No"], color:"azul" },
            { texto: "¿Se realizan medidas correctivas con base en los análisis reportados por el laboratorio asignado?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí o No son requeridas"], color:"azul" },
            { texto: "¿Al menos uno de los análisis de laboratorio evidencia  algún parámetro fuera de la norma?", puntos: 1, porcentaje: 4, opciones: ["Sí", "No"], color:"azul" },
            { texto: "¿Se realiza el control operativo?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se realiza el análisis N1 según la periodicidad establecida?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se realiza el análisis N2 y N3 según la periodicidad establecida?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Existe algún reporte de no conformidad en la calidad del agua?", puntos: 1, porcentaje: 1, opciones: ["Sí", "No"], color:"azul" },
            { texto: "¿Realizan mediciones de presión para verificar el cumplimiento de los parámetros mínimos y máximos establecidos?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se está ejecutando un Plan de gestión del riesgo y adaptación al cambio climático?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Cuenta con sistema de desinfección funcionando adecuadamente?", puntos: 1, porcentaje: 4, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se cuenta con un estudio técnico integral del sistema?", puntos: 2, porcentaje: 3, opciones: ["No", "En proceso de aprobación", "Aprobado"], color:"azul" },
            { texto: "¿Se cumple con el Reglamento de Normas Técnicas y Procedimientos para el Mantenimiento Preventivo de los Sistemas de Abastecimiento de Agua?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" }
        ]
    },
    {
        nombre: "Gestión Administrativa Financiera",
        color: "azul", tipo: "principal",
        preguntas: [
            { texto: "¿Con cuáles herramientas se cuentan para la gestión del ente operador?", puntos: 3, porcentaje: 1, opciones: ["Ninguna", "Herramientas físicas", "Herramientas Digitales (Auxiliares)", "Software"], color:"azul" },
            { texto: "¿Cuentan con un lugar que funcione como bodega de materiales para la operación y mantenimiento?", puntos: 3, porcentaje: 1, opciones: ["No", "Vivienda Particular", "Instalación Comunal", "Bodega"], color:"azul" },
            { texto: "¿Se realizan registros de entradas y salidas del lugar donde guardan los materiales?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Los Estados Financieros son enviados al AyA semestralmente?", puntos: 1, porcentaje: 3, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿En qué medios se respalda la información Financiera?", puntos: 2, porcentaje: 2, opciones: ["No hay", "Medios Físicos (Oficina Acueducto)", "Medios Electrónicos o digitales"], color:"azul" },
            { texto: "¿Cuenta con servicios de contaduría contratado?", puntos: 2, porcentaje: 1, opciones: ["No", "Sin contrato", "Con contrato"], color:"azul" },
            { texto: "¿Cuenta con fontanero contratado?", puntos: 2, porcentaje: 2, opciones: ["No", "Sin contrato", "Con contrato"], color:"azul" },
            { texto: "¿Cuenta con administrador o asistente administrativo contratado?", puntos: 2, porcentaje: 2, opciones: ["No", "Sin contrato", "Con contrato"], color:"azul" },
            { texto: "¿Cuenta con permiso sanitario de funcionamiento?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Cuenta con Convenio de Delegación?", puntos: 1, porcentaje: 4, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Tiene todos los libros legales al día (Actas Junta Directiva, Asambleas y de Socios)", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Tiene todos los libros contables al día (Mayor, Diario e Inventario y Balances?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Se sigue un procedimiento establecido para la atención de quejas, consultas y/o denuncias interpuestas?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Cuál es el porcentaje de morosidad mensual?", puntos: 2, porcentaje: 2, opciones: [">10%", "<10%", "0%"], color:"azul" },
            { texto: "¿El presupuesto y el plan de trabajo anual están aprobados por el AyA?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Mantienen la contabilidad separada según su actividad? (Hidrantes, Alcantarillado,  Tarifa Hídrica, Acueducto)", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"azul" },
            { texto: "¿Cómo se custodian los ingresos?", puntos: 2, porcentaje: 2, opciones: ["Custodia física en la ASADA", "Cta. Bancaria Particular", "Cta. Bancaria de ASADA"], color:"azul" }
        ]
    },
    {
        nombre: "Variables de Riesgo",
        color: "roja", tipo: "sancion",
        preguntas: [
            { texto: "¿Se tienen documentadas irregularidades financieras por parte del AyA u otra institución? (Eje financiero)", puntos: 1, porcentaje: -0.5, opciones: ["No", "Sí"], color:"roja" },
            { texto: "¿Se tienen criterios en contra del operador basadas en denuncias interpuestas al operador?", puntos: 1, porcentaje: -0.5, opciones: ["No", "Sí"], color:"roja" },
            { texto: "¿Existen órdenes sanitarias y/o no conformidades?", puntos: 1, porcentaje: -0.5, opciones: ["No", "Sí"], color:"roja" },
            { texto: "¿El ente operador sigue dando disponibilidades de agua cuando no existe factibilidad?", puntos: 1, porcentaje: -0.5, opciones: ["No", "Sí"], color:"roja" },
            { texto: "¿Tienen algún parámetro de calidad con un índice del valor del riesgo mayor a código amarillo según el \"Índice de Riesgo de la Calidad del Agua para Consumo Humano\"?", puntos: 1, porcentaje: -0.5, opciones: ["No", "Sí"], color:"roja" },
            { texto: "¿Ha realizado el operador ampliaciones y/o mejoras sin llevar el debido proceso?", puntos: 1, porcentaje: -0.5, opciones: ["No", "Sí"], color:"roja" }
        ]
    },
    {
        nombre: "Incentivos",
        color: "verde", tipo: "extra",
        preguntas: [
            { texto: "¿Aplica tarifas para la protección del recurso hídrico?", puntos: 1, porcentaje: 0.5, opciones: ["No", "Sí"], color:"verde" },
            { texto: "¿El ente operador notifica a las personas usuarias sobre facturaciones atípicas? (más elevadas de lo acostumbrado)", puntos: 1, porcentaje: 0.5, opciones: ["No", "Sí"], color:"verde" },
            { texto: "¿El ente operador cuenta con terrenos inscritos a su nombre y/o servidumbres?", puntos: 1, porcentaje: 0.5, opciones: ["No", "Sí"], color:"verde" },
            { texto: "¿El ente operador participa en las capacitaciones coordinadas por la institución al último semestre?", puntos: 1, porcentaje: 0.5, opciones: ["No", "Sí"], color:"verde" },
            { texto: "¿Se cuenta con personal adicional al requerido?", puntos: 1, porcentaje: 0.5, opciones: ["No", "Sí"], color:"verde" },
            { texto: "¿Se cumple con la ley 8901 de la participación mujeres?", puntos: 1, porcentaje: 0.5, opciones: ["No", "Sí"], color:"verde" }
        ]
    },
    {
        nombre: "Gestión de Saneamiento",
        color: "verde", tipo: "extra", // OPCIONAL
        preguntas: [
            { texto: "¿Cuál es la condición del Alcantarillado Sanitario?", puntos: 2, porcentaje: 2, opciones: ["Sin tratamiento", "Previsto para tratamiento", "Con tratamiento"], color:"verde" },
            { texto: "¿Cuál es la valoración operativa de la planta?", puntos: 3, porcentaje: 3, opciones: ["Malo", "Regular", "Bueno", "Excelente"], color:"verde" },
            { texto: "¿La planta cumple con el reglamento de vertido y reúso?", puntos: 1, porcentaje: 3, opciones: ["No", "Sí"], color:"verde" },
            { texto: "¿Se presentan reportes operacionales al Ministerio de Salud?", puntos: 1, porcentaje: 2, opciones: ["No", "Sí"], color:"verde" }
        ]
    }
];

const PAGINAS = [
    { id: "pagina-general" }
];
EJES.forEach((e, idx) => PAGINAS.push({ id: `pagina-eje-${idx}`, eje: e }));
PAGINAS.push({ id: "pagina-resumen" });

let respuestas = {}; // { eje_idx: [ respuestas ] }
let paginaActual = 0;

function agregarResponsable() {
    const responsables = document.getElementById('responsables');
    const div = document.createElement('div');
    div.className = 'responsable';
    div.innerHTML = `
        <label>Puesto <span class="obligatorio">*</span>:</label>
        <input type="text" name="puesto[]" required><br>
        <label>Nombre <span class="obligatorio">*</span>:</label>
        <input type="text" name="nombre[]" required>
        <button type="button" class="boton" onclick="this.parentNode.remove()">Quitar</button>
    `;
    responsables.appendChild(div);
}

function avanzarPagina(siguiente) {
    if (paginaActual === 0) {
        // Validación de la info general
        const asada = document.getElementById('asada').value.trim();
        const puestos = document.getElementsByName('puesto[]');
        const nombres = document.getElementsByName('nombre[]');
        if (!asada) {
            alert('El campo "Nombre de la ASADA" es obligatorio.');
            return;
        }
        let ok = false;
        for (let i = 0; i < puestos.length; i++) {
            if (puestos[i].value.trim() && nombres[i].value.trim()) ok = true;
        }
        if (!ok) {
            alert('Debe ingresar al menos un responsable con puesto y nombre.');
            return;
        }
    }
    // Validar todos los ejes EXCEPTO "Gestión de Saneamiento" (último)
    if (paginaActual >= 1 && paginaActual < EJES.length) {
        // Validar que todas las preguntas del eje estén respondidas, excepto Incentivos si está bloqueado
        const eje = EJES[paginaActual-1];
        if (eje.nombre === "Incentivos" && !puedeResponderIncentivos()) {
            // Permitido avanzar aunque esté bloqueado
        } else {
            const totalPregs = eje.preguntas.length;
            let contestadas = 0;
            for (let i = 0; i < totalPregs; i++) {
                if (document.querySelector(`input[name="eje_${paginaActual-1}_p${i}"]:checked`)) contestadas++;
            }
            if (contestadas < totalPregs) {
                alert("Debe responder todas las preguntas antes de continuar.");
                return;
            }
        }
    }
    // Saneamiento (último eje) es opcional: nunca se valida
    mostrarPagina(siguiente);
}

function mostrarPagina(n) {
    PAGINAS.forEach((p, idx) => {
        const seccion = document.getElementById(p.id);
        if (seccion) seccion.classList.toggle('oculto', idx !== n);
    });
    paginaActual = n;
    if (n >= 1 && n <= EJES.length) renderizarEje(n-1);
    if (n === PAGINAS.length-1) renderizarResumen();
    window.scrollTo(0,0);
}

function volverARespuestas() {
    mostrarPagina(EJES.length); // última página de ejes antes de resumen
}

function renderizarEje(idx) {
    const idSec = `pagina-eje-${idx}`;
    let sec = document.getElementById(idSec);
    if (!sec) {
        // Crear sección solo la primera vez
        sec = document.createElement('section');
        sec.id = idSec;
        document.querySelector("main").insertBefore(sec, document.getElementById("pagina-resumen"));
    }
    const eje = EJES[idx];
    let html = `<h2>Eje Temático: <span class="${eje.color}">${eje.nombre}</span></h2>`;
    // Mensaje bloqueo incentivos
    let bloquear = false, mensajeBloqueo = "";
    if (eje.nombre === "Incentivos" && !puedeResponderIncentivos()) {
        bloquear = true;
        mensajeBloqueo = `<div class="info-mensaje"><b>No puede completar esta sección.</b><br>
        Para acceder a los incentivos debe:<ul>
        <li>No tener ninguna Variable de Riesgo respondida como "Sí".</li>
        <li>Obtener al menos un 60% en los ejes temáticos principales.</li>
        </ul></div>`;
    }
    html += mensajeBloqueo;
    html += `<form id="form-eje-${idx}" autocomplete="off" onsubmit="event.preventDefault();avanzarPagina(${idx+2})">`;
    eje.preguntas.forEach((q, i) => {
        let resp = (respuestas[idx] || [])[i];
        html += `<div class="pregunta">
            <div><b class="${q.color}">${i+1}. ${q.texto}</b></div>
            <div class="porcentaje">Valor: ${Math.abs(q.porcentaje).toFixed(2)}%</div>
            <div id="porcentaje-obtenido-${idx}-${i}" class="porcentaje" style="background:#f0fff4;color:#228;">Obtenido: 0.00%</div>
            `;
        q.opciones.forEach((op, j) => {
            let checked = resp === j ? "checked" : "";
            let disab = (eje.nombre === "Incentivos" && bloquear) ? "disabled" : "";
            html += `<div class="radio-grupo">
                <input type="radio" name="eje_${idx}_p${i}" id="eje_${idx}_p${i}_opt${j}" value="${j}" ${checked} ${disab}
                    onclick="seleccionarOpcion(${idx},${i},${j})">
                <label for="eje_${idx}_p${i}_opt${j}">${op}</label>
            </div>`;
        });
        html += `</div>`;
    });
    // Totalizador del eje
    html += `<div class="totalizador">
        <div>Puntaje total obtenido: <span class="puntaje" id="total-puntos-${idx}">0</span></div>
        <div>Porcentaje total obtenido: <span class="puntaje" id="total-porcentaje-${idx}">0.00%</span></div>
    </div>
    <div class="nav">
        <button type="button" class="boton" onclick="avanzarPagina(${idx})">Volver</button>
        <button type="submit" class="boton">Siguiente</button>
    </div>
    </form>`;
    sec.innerHTML = html;
    sec.classList.remove("oculto");
    // Inicializar resultados
    actualizarResultadosEje(idx);
}

function seleccionarOpcion(ejeIdx, pregIdx, val) {
    if (!respuestas[ejeIdx]) respuestas[ejeIdx] = [];
    respuestas[ejeIdx][pregIdx] = parseInt(val);
    actualizarResultadosEje(ejeIdx);

    // Actualizar bloqueo y renderizado incentivos si existe
    const idxIncentivos = EJES.findIndex(e => e.nombre === "Incentivos");
    if (idxIncentivos !== -1) {
        actualizarBloqueoIncentivos(idxIncentivos);
    }

    // Si estamos en incentivos, refrescar la página de incentivos para que UI quede bien
    if (ejeIdx === idxIncentivos) {
        renderizarEje(idxIncentivos);
    }
}
function actualizarBloqueoIncentivos(idxIncentivos) {
    const bloqueado = !puedeResponderIncentivos();
    const secIncentivos = document.getElementById(`pagina-eje-${idxIncentivos}`);
    if (!secIncentivos) return;

    // Mostrar/Ocultar mensaje bloqueo
    let mensaje = secIncentivos.querySelector('.info-mensaje');
    if (bloqueado) {
        if (!mensaje) {
            mensaje = document.createElement('div');
            mensaje.className = 'info-mensaje';
            mensaje.innerHTML = `<b>No puede completar esta sección.</b><br>
                Para acceder a los incentivos debe:<ul>
                <li>No tener ninguna Variable de Riesgo respondida como "Sí".</li>
                <li>Obtener al menos un 60% en los ejes temáticos principales.</li>
                </ul>`;
            secIncentivos.insertBefore(mensaje, secIncentivos.firstChild);
        }
    } else {
        if (mensaje) mensaje.remove();
    }

    // Bloquear o desbloquear inputs según el estado
    const inputs = secIncentivos.querySelectorAll('input[type=radio]');
    inputs.forEach(input => input.disabled = bloqueado);

    // Actualizar totales para que refleje 0 si está bloqueado
    actualizarResultadosEje(idxIncentivos);
}


function actualizarResultadosEje(ejeIdx) {
    const eje = EJES[ejeIdx];
    let total_puntos = 0, total_puntos_max = 0, total_porcentaje = 0;

    // Detectar si incentivos están bloqueados (solo afecta a ese eje)
    const incentivosBloqueados = (eje.nombre === "Incentivos") && !puedeResponderIncentivos();

    for (let i = 0; i < eje.preguntas.length; i++) {
        const q = eje.preguntas[i];
        let val = respuestas[ejeIdx] && respuestas[ejeIdx][i] !== undefined ? respuestas[ejeIdx][i] : null;
        let puntos = 0, porcentaje = 0;
        if (val !== null) {
            puntos = (q.porcentaje < 0)
                ? (q.opciones.length === 2 && val === 1 ? 1 : 0)
                : val;
            if (q.porcentaje < 0) { // Pregunta de sanción
                porcentaje = (puntos === 1) ? q.porcentaje : 0;
            } else {
                porcentaje = ((puntos / q.puntos) * q.porcentaje);
            }

            // Si está bloqueado incentivos, no sumar puntos ni porcentaje
            if (!incentivosBloqueados) {
                total_puntos += puntos;
                total_porcentaje += porcentaje;
            }
        }
        document.getElementById(`porcentaje-obtenido-${ejeIdx}-${i}`).textContent = `Obtenido: ${incentivosBloqueados ? "0.00" : porcentaje.toFixed(2)}%`;
        total_puntos_max += q.puntos;
    }
    document.getElementById(`total-puntos-${ejeIdx}`).textContent = incentivosBloqueados ? "0" : total_puntos;
    document.getElementById(`total-porcentaje-${ejeIdx}`).textContent = incentivosBloqueados ? "0.00%" : `${total_porcentaje.toFixed(2)}%`;
}


function puedeResponderIncentivos() {
    // Ninguna variable de riesgo debe estar "Sí"
    const idxRiesgo = EJES.findIndex(e => e.nombre === "Variables de Riesgo");
    let riesgoOk = true;
    if (respuestas[idxRiesgo]) {
        for (let i = 0; i < EJES[idxRiesgo].preguntas.length; i++) {
            if (respuestas[idxRiesgo][i] === 1) riesgoOk = false;
        }
    }
    // % en ejes principales debe ser >=60%
    let total = 0;
    let ejesPrincipales = EJES.filter(e => e.tipo === "principal");
    for (let e = 0; e < ejesPrincipales.length; e++) {
        let idx = EJES.findIndex(ej => ej.nombre === ejesPrincipales[e].nombre);
        if (respuestas[idx]) {
            for (let i = 0; i < ejesPrincipales[e].preguntas.length; i++) {
                let q = ejesPrincipales[e].preguntas[i];
                let val = respuestas[idx][i];
                if (val !== undefined) total += ((val / q.puntos) * q.porcentaje);
            }
        }
    }
    return riesgoOk && total >= 60;
}

// ================= RESUMEN FINAL Y PDF ====================

function getCategoria(percent) {
    if (percent >= 85) return { cat:"A", clase:"verde" };
    if (percent >= 75) return { cat:"B", clase:"naranja" };
    if (percent >= 60) return { cat:"C", clase:"amarillo" };
    return { cat:"D", clase:"roja" };
}

function renderizarResumen() {
    // --- Información general al inicio del resumen ---
    let infoHtml = '<div class="info-general-resumen"><b>Información General</b><br>';
    infoHtml += `<b>Fecha:</b> ${document.getElementById('fecha').value || "-"}<br>`;
    infoHtml += `<b>Nombre ASADA:</b> ${document.getElementById('asada').value || "-"}<br>`;
    infoHtml += `<b>Región:</b> ${document.getElementById('region').value || "-"}<br>`;
    infoHtml += `<b>Provincia:</b> ${document.getElementById('provincia').value || "-"}<br>`;
    infoHtml += `<b>Cantón:</b> ${document.getElementById('canton').value || "-"}<br>`;
    infoHtml += `<b>Distrito:</b> ${document.getElementById('distrito').value || "-"}<br>`;
    infoHtml += `<b>Teléfono:</b> ${document.getElementById('telefono').value || "-"}<br>`;
    infoHtml += `<b>Número de conexiones:</b> ${document.getElementById('conexiones').value || "-"}<br>`;
    infoHtml += `<b>Número de comunidades:</b> ${document.getElementById('comunidades').value || "-"}<br>`;
    // Responsables
    infoHtml += `<b>Responsables:</b><br>`;
    let puestos = document.getElementsByName('puesto[]');
    let nombres = document.getElementsByName('nombre[]');
    for (let i = 0; i < puestos.length; i++) {
        if (puestos[i].value.trim() && nombres[i].value.trim()) {
            infoHtml += `&bull; <b>${puestos[i].value}</b> - ${nombres[i].value}<br>`;
        }
    }
    infoHtml += '</div>';
    document.getElementById('info-general-resumen').innerHTML = infoHtml;

    // Resumen por eje, SIN categoría individual
    let html = `<table class="tabla-resumen">
        <thead>
        <tr>
            <th style="background:#2776b7; color:#fff;">RESUMEN DE RESULTADOS POR EJE TEMÁTICO</th>
            <th style="background:#2776b7; color:#fff; text-align:center;">%</th>
        </tr>
        </thead>
        <tbody>`;
   let totalPercent = 0;
for (let idx = 0; idx < EJES.length; idx++) {
    const eje = EJES[idx];
    const incentivosBloqueados = (eje.nombre === "Incentivos") && !puedeResponderIncentivos();

    let percent = 0;
    if (respuestas[idx] && !incentivosBloqueados) {
        for (let i = 0; i < eje.preguntas.length; i++) {
            let q = eje.preguntas[i];
            let val = respuestas[idx][i];
            if (val !== undefined) {
                let puntos = (q.porcentaje < 0)
                    ? (q.opciones.length === 2 && val === 1 ? 1 : 0)
                    : val;
                let porc = (q.porcentaje < 0)
                    ? (puntos === 1 ? q.porcentaje : 0)
                    : ((puntos / q.puntos) * q.porcentaje);
                percent += porc;
            }
        }
    }
    percent = Math.round(percent*100)/100; // 2 decimales
    if (!incentivosBloqueados) totalPercent += percent;

    html += `<tr>
        <td class="${eje.color}" style="color:#2776b7;">${eje.nombre}</td>
        <td style="text-align:center;">${percent.toFixed(2)}%</td>
    </tr>`;
}
totalPercent = Math.min(totalPercent, 100);

    html += `</tbody>
        <tfoot><tr>
            <td class="total-fila" style="background:#2776b7; color:#fff;">TOTAL</td>
            <td class="total-fila" style="background:#2776b7; color:#fff; text-align:center;">${totalPercent.toFixed(2)}%</td>
        </tr></tfoot>
    </table>`;
    document.getElementById('resumen-ejes').innerHTML = html;

    // Categoría final
    let catGlobal = getCategoria(totalPercent);
    document.getElementById('categoria-resultado').innerHTML = `<span style="font-size:2.2em;font-weight:bold;">CATEGORÍA FINAL: </span> <span class="categoria-celda ${catGlobal.clase}" style="font-size:2.9em;margin-left:18px;">${catGlobal.cat}</span>`;

    // ---- Cuadro informativo de categorías por código (no imagen) ----
    let cuadroCat = `
        <div class="cuadro-informativo-categorias">
        <table>
            <thead>
                <tr>
                    <th colspan="3" style="background:#2776b7; color:#fff; text-align:center;">CUADRO INFORMATIVO SOBRE LAS CATEGORIZACIONES PRODUCTO DE ESTA EVALUACIÓN</th>
                </tr>
                <tr>
                    <th style="background:#2776b7; color:#fff;">CATEGORÍA</th>
                    <th style="background:#2776b7; color:#fff;">DESCRIPCIÓN DE LA CATEGORÍA</th>
                    <th style="background:#2776b7; color:#fff;">REQUERIMIENTO PARA ESTA CLASIFICACIÓN</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="verde"><b>A</b></td>
                    <td>Consolidada</td>
                    <td>Igual o mayor a 85</td>
                </tr>
                <tr>
                    <td class="naranja"><b>B</b></td>
                    <td>En Desarrollo Alto</td>
                    <td>Igual o mayor a 75 y menor a 85</td>
                </tr>
                <tr>
                    <td class="amarillo"><b>C</b></td>
                    <td>En Desarrollo Bajo</td>
                    <td>Igual o mayor a 60 y menor a 75</td>
                </tr>
                <tr>
                    <td class="roja"><b>D</b></td>
                    <td>Débil</td>
                    <td>Menor a 60</td>
                </tr>
            </tbody>
        </table>
        </div>
    `;
    document.getElementById('cuadro-informativo-categorias').innerHTML = cuadroCat;

    // --- DETALLE DE PREGUNTAS ---
    let htmlDetalle = '<h3>Detalle por Pregunta</h3>';
    for (let idx = 0; idx < EJES.length; idx++) {
        let eje = EJES[idx];
        htmlDetalle += `<table class="tabla-detalle" style="width:100%; border-collapse: collapse; margin-top: 30px; margin-bottom: 26px;">
        <thead>
            <tr>
                <th colspan="4" style="background:#2776b7; color:#fff;">${eje.nombre}</th>
            </tr>
            <tr>
                <th style="background:#2776b7; color:#fff;">#</th>
                <th style="background:#2776b7; color:#fff;">Pregunta</th>
                <th style="background:#2776b7; color:#fff;">Respuesta</th>
                <th style="background:#2776b7; color:#fff;">% Obtenido</th>
            </tr>
        </thead>
        <tbody>`;
        let subtotal = 0;
        for (let i = 0; i < eje.preguntas.length; i++) {
            let q = eje.preguntas[i];
            let val = respuestas[idx] && respuestas[idx][i] !== undefined ? respuestas[idx][i] : null;
            let respuestaStr = (val !== null) ? q.opciones[val] : '-';
            let puntos = 0, porcentaje = 0;
            if (val !== null) {
                puntos = (q.porcentaje < 0)
                    ? (q.opciones.length === 2 && val === 1 ? 1 : 0)
                    : val;
                porcentaje = (q.porcentaje < 0)
                    ? (puntos === 1 ? q.porcentaje : 0)
                    : ((puntos / q.puntos) * q.porcentaje);
            }
            subtotal += porcentaje;
            htmlDetalle += `<tr>
                <td>${i+1}</td>
                <td class="${q.color}">${q.texto}</td>
                <td>${respuestaStr}</td>
                <td style="text-align:center;">${porcentaje.toFixed(2)}%</td>
            </tr>`;
        }
        htmlDetalle += `<tr class="subtotal">
            <td colspan="3">Subtotal</td>
            <td style="text-align:center;">${subtotal.toFixed(2)}%</td>
        </tr>`;
        htmlDetalle += `</tbody></table>`;
    }
    document.getElementById('detalle-preguntas').innerHTML = htmlDetalle;
}


// =========== EXPORTAR PDF ==========
// =========== EXPORTAR PDF ==========
function exportarPDF() {
    let nombreAsada = document.getElementById('asada').value.trim();
    let fileName = `Categorización_ASADA_${nombreAsada || "sin_nombre"}.pdf`;
    let elem = document.getElementById("pagina-resumen");

    // Crear estilo temporal para evitar cortes y ocultar botones SOLO en PDF
    const style = document.createElement('style');
    style.id = 'estilo-pdf-temporal';
    style.innerHTML = `
        table, tr, th, td {
            page-break-inside: avoid !important;
        }
        .nav {
            display: none !important;
        }
    `;
    document.head.appendChild(style);

    // Ajustar estilos para exportación
    elem.style.padding = "10px";
    elem.style.maxWidth = "700px";  // Ajustamos el ancho para evitar cortes
    elem.style.margin = "auto";

    html2pdf()
        .set({
            margin: [0.2, 0.15, 0.2, 0.15], // top, left, bottom, right
            filename: fileName,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: 1.5,  // menos escala para que no se corte
                dpi: 192,
                letterRendering: true,
                useCORS: true,
                scrollY: 0
            },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait', compressPDF: true }
        })
        .from(elem)
        .save()
        .then(() => {
            // Restaurar estilos después de exportar
            elem.style.padding = "";
            elem.style.maxWidth = "";
            elem.style.margin = "";
            // Quitar el estilo temporal para que vuelva todo a la normalidad
            const styleTmp = document.getElementById('estilo-pdf-temporal');
            if (styleTmp) styleTmp.remove();
        });
}


// ==== Inicialización ====
// Cargar primeras secciones
window.onload = function() {
    mostrarPagina(0);
};

</script>
</body>
</html>